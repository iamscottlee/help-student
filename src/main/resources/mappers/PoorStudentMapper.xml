<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.help.dao.PoorStudentMapper">

    <resultMap id="BaseResultMap" type="com.project.help.pojo.PoorStudent">

        <result column="stu_num" jdbcType="VARCHAR" property="stuNum" />
        <result column="stu_name" jdbcType="VARCHAR" property="stuName" />
        <result column="stu_major" jdbcType="VARCHAR" property="stuMajor" />
        <result column="avg_money" jdbcType="DOUBLE" property="avgMoney" />
        <result column="variance" jdbcType="DOUBLE" property="variance" />
        <result column="rate" jdbcType="DOUBLE" property="rate" />

    </resultMap>

    <select id="selectPoorStudent" resultMap="BaseResultMap">
    SELECT
	student.stu_num,
	student.stu_name,
	student.stu_major,
	temp1.avg_money,
	temp1.variance,
	temp2.rate
FROM
	student,
	(
		SELECT
			student_num,
			LAST_DAY(data_time) AS MONTH,
			sum(money) / (SELECT DAY(MONTH)) AS avg_money,
			STD(money) AS variance
		FROM
			`data`
		WHERE
			place != '4'
		GROUP BY
			student_num,
			DATE_FORMAT(data_time, '%Y-%m')
		HAVING
			avg_money BETWEEN 1500
		AND 3000
	) AS temp1,
	(
		SELECT
			student_num,
			rate
		FROM
			(
				SELECT
					temp_a.student_num,
					count1 / count2 AS rate
				FROM
					(
						SELECT
							student_num,
							COUNT(place) AS count1
						FROM
							`data`
						WHERE
							place IN ('1', '2', '3')
						GROUP BY
							student_num
					) AS temp_a,
					(
						SELECT
							student_num,
							COUNT(place) AS count2
						FROM
							`data`
						GROUP BY
							student_num
					) AS temp_b
				WHERE
					temp_a.student_num = temp_b.student_num
			) AS temp3
		WHERE
			rate > 0.90
	) AS temp2
WHERE
	student.stu_num = temp1.student_num
AND temp1.student_num = temp2.student_num
ORDER BY
	variance
    </select>

</mapper>